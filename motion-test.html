<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Horse Motion Test</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #1a1a2e;
      color: white;
      overflow: hidden;
    }
    #canvas-container {
      width: 100vw;
      height: 100vh;
    }
    #controls {
      position: fixed;
      top: 20px;
      left: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 100;
    }
    .btn {
      padding: 12px 24px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: left;
    }
    .btn:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    .btn:active {
      transform: scale(0.98);
    }
    .btn.active {
      outline: 3px solid white;
      outline-offset: 2px;
    }
    .btn-idle { background: linear-gradient(135deg, #607d8b, #546e7a); color: white; }
    .btn-run { background: linear-gradient(135deg, #4CAF50, #45a049); color: white; }
    .btn-boost { background: linear-gradient(135deg, #ff6b6b, #ee5a5a); color: white; }
    .btn-stun { background: linear-gradient(135deg, #9c27b0, #7b1fa2); color: white; }
    .btn-back { background: linear-gradient(135deg, #2196F3, #1976D2); color: white; }
    .btn-shock { background: linear-gradient(135deg, #ffeb3b, #fbc02d); color: #333; }
    .btn-walk { background: linear-gradient(135deg, #ff9800, #f57c00); color: white; }
    .btn-fallen { background: linear-gradient(135deg, #795548, #5d4037); color: white; }

    #info {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0,0,0,0.7);
      padding: 20px;
      border-radius: 10px;
      min-width: 220px;
    }
    #info h3 {
      margin-bottom: 10px;
      color: #4CAF50;
    }
    #current-motion {
      font-size: 28px;
      font-weight: bold;
      color: #ffeb3b;
      margin-bottom: 10px;
    }
    #motion-desc {
      font-size: 14px;
      color: #aaa;
      margin-bottom: 15px;
    }
    #camera-controls {
      position: fixed;
      bottom: 20px;
      left: 20px;
      display: flex;
      gap: 10px;
    }
    .cam-btn {
      padding: 10px 20px;
      background: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.3);
      color: white;
      border-radius: 5px;
      cursor: pointer;
    }
    .cam-btn:hover {
      background: rgba(255,255,255,0.3);
    }
    .cam-btn.active {
      background: #4CAF50;
      border-color: #4CAF50;
    }
  </style>
</head>
<body>
  <div id="canvas-container"></div>

  <div id="controls">
    <button class="btn btn-idle" data-motion="idle">ğŸ§ IDLE (ê°€ë§Œíˆ)</button>
    <button class="btn btn-run active" data-motion="run">ğŸƒ RUN (ë‹¬ë¦¬ê¸°)</button>
    <button class="btn btn-boost" data-motion="boost">ğŸš€ BOOST (ìŠ¤í¼íŠ¸)</button>
    <button class="btn btn-stun" data-motion="stun">ğŸ’¤ STUN (ë”´ì²­/ì ìê¸°)</button>
    <button class="btn btn-back" data-motion="back">ğŸ”™ BACK (ë’¤ë¡œê°€ê¸°)</button>
    <button class="btn btn-shock" data-motion="shock">âš¡ SHOCK (ë²ˆê°œë§ìŒ)</button>
    <button class="btn btn-walk" data-motion="walk">ğŸš¶ WALK (ì§ë¦½ë³´í–‰)</button>
    <button class="btn btn-fallen" data-motion="fallen">ğŸ’¥ FALLEN (ë„˜ì–´ì§)</button>
  </div>

  <div id="info">
    <h3>Current Motion</h3>
    <div id="current-motion">RUN</div>
    <div id="motion-desc">ê¸°ë³¸ ë‹¬ë¦¬ê¸° ëª¨ì…˜</div>
    <hr style="margin: 15px 0; border-color: #444;">
    <div style="font-size: 12px; color: #aaa;">
      <p>ğŸ–±ï¸ ë“œë˜ê·¸: íšŒì „</p>
      <p>ğŸ” ìŠ¤í¬ë¡¤: ì¤Œ</p>
      <p>ğŸ“ motion.js ì‹¤ì‹œê°„ ë°˜ì˜</p>
    </div>
  </div>

  <div id="camera-controls">
    <button class="cam-btn active" data-view="0">ì •ë©´</button>
    <button class="cam-btn" data-view="1">ì¸¡ë©´</button>
    <button class="cam-btn" data-view="2">ìœ„</button>
    <button class="cam-btn" data-view="3">ë’¤</button>
    <button class="cam-btn" data-view="4">45ë„</button>
  </div>


  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js';
    // ì‹¤ì œ motion.js import
    import { MotionConfig, updateMotion, resetMotion } from './src/motion.js';
    import { SkillType } from './src/skills.js';

    let scene, camera, renderer, controls;
    let horse = null;
    let currentMotion = 'run';

    const motionDescriptions = {
      idle: 'ê°€ë§Œíˆ ì„œìˆê¸° (ìˆ¨ì‰¬ê¸°)',
      run: 'ê¸°ë³¸ ë‹¬ë¦¬ê¸° ëª¨ì…˜',
      boost: 'ìŠ¤í¼íŠ¸ (ë‹¬ë¦¬ê¸°ì™€ ë™ì¼, ì†ë„ë§Œ ë‹¤ë¦„)',
      stun: 'ì˜†ìœ¼ë¡œ ëˆ•ê³  ìˆ¨ì‰¬ê¸° (Zzz...)',
      back: '180ë„ íšŒì „ í›„ ë’¤ë¡œ ë‹¬ë¦¬ê¸°',
      shock: 'ë²ˆê°œ ë§ê³  ê²½ë ¨ + íŒŒë‹¥íŒŒë‹¥',
      walk: 'ë’·ë°œë¡œ ì§ë¦½ ë³´í–‰ (ìœ„í˜‘ì˜ í–‰ì§„)',
      fallen: 'ì•ìœ¼ë¡œ ê³ ê¾¸ë¼ì§',
    };

    function init() {
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x87ceeb);

      camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.position.set(50, 30, 50);

      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.shadowMap.enabled = true;
      document.getElementById('canvas-container').appendChild(renderer.domElement);

      controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;
      controls.target.set(0, 15, 0);

      // Lights
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
      scene.add(ambientLight);

      const dirLight = new THREE.DirectionalLight(0xffffff, 1);
      dirLight.position.set(50, 100, 50);
      dirLight.castShadow = true;
      scene.add(dirLight);

      // Ground
      const groundGeo = new THREE.PlaneGeometry(200, 200);
      const groundMat = new THREE.MeshLambertMaterial({ color: 0xc4a76c });
      const ground = new THREE.Mesh(groundGeo, groundMat);
      ground.rotation.x = -Math.PI / 2;
      ground.receiveShadow = true;
      scene.add(ground);

      // Grid
      const grid = new THREE.GridHelper(200, 20, 0x888888, 0x444444);
      grid.position.y = 0.1;
      scene.add(grid);

      createHorse();
      setupEventListeners();
      animate();
    }

    function createHorse() {
      const color = 0xff6b6b;

      horse = {
        mesh: new THREE.Group(),
        body: null,
        headGroup: new THREE.Group(),
        head: null,
        neck: null,
        legs: [],
        tail: null,
        earL: null,
        earR: null,
        isReversed: false,
        wobbleOffset: 0,
      };

      const bodyMat = new THREE.MeshStandardMaterial({ color });
      const headMat = new THREE.MeshStandardMaterial({ color });
      const whiteMat = new THREE.MeshStandardMaterial({ color: 0xffffff });
      const blackMat = new THREE.MeshStandardMaterial({ color: 0x111111 });
      const hoofMat = new THREE.MeshStandardMaterial({ color: 0x333333 });

      // ëª¸í†µ (CapsuleGeometry)
      const bodyGeo = new THREE.CapsuleGeometry(6, 18, 8, 16);
      horse.body = new THREE.Mesh(bodyGeo, bodyMat);
      horse.body.rotation.x = Math.PI / 2;
      horse.body.position.set(0, 15, 0);
      horse.body.castShadow = true;
      horse.mesh.add(horse.body);

      // ëª©+ë¨¸ë¦¬ ê·¸ë£¹
      horse.headGroup.position.set(0, 18, -12);

      // ëª©
      const neckGeo = new THREE.CylinderGeometry(3, 4, 14, 8);
      horse.neck = new THREE.Mesh(neckGeo, bodyMat);
      horse.neck.position.set(0, 5, -3);
      horse.neck.rotation.x = -0.6;
      horse.neck.castShadow = true;
      horse.headGroup.add(horse.neck);

      // ë¨¸ë¦¬
      const headGeo = new THREE.BoxGeometry(5, 6, 14);
      horse.head = new THREE.Mesh(headGeo, headMat);
      horse.head.position.set(0, 12, -10);
      horse.head.rotation.x = -0.3;
      horse.head.castShadow = true;
      horse.headGroup.add(horse.head);

      // ì£¼ë‘¥ì´
      const snoutGeo = new THREE.BoxGeometry(4, 4, 5);
      const snout = new THREE.Mesh(snoutGeo, headMat);
      snout.position.set(0, -1, -8);
      horse.head.add(snout);

      // ì½§êµ¬ë©
      const nostrilGeo = new THREE.SphereGeometry(0.5, 6, 6);
      const nostrilL = new THREE.Mesh(nostrilGeo, blackMat);
      nostrilL.position.set(-1, -1, -2.5);
      snout.add(nostrilL);
      const nostrilR = new THREE.Mesh(nostrilGeo, blackMat);
      nostrilR.position.set(1, -1, -2.5);
      snout.add(nostrilR);

      // ëˆˆ
      const eyeGeo = new THREE.SphereGeometry(1, 8, 8);
      const eyeL = new THREE.Mesh(eyeGeo, whiteMat);
      eyeL.position.set(-2.5, 1, -2);
      horse.head.add(eyeL);
      const eyeR = new THREE.Mesh(eyeGeo, whiteMat);
      eyeR.position.set(2.5, 1, -2);
      horse.head.add(eyeR);

      // ëˆˆë™ì
      const pupilGeo = new THREE.SphereGeometry(0.5, 6, 6);
      const pupilL = new THREE.Mesh(pupilGeo, blackMat);
      pupilL.position.set(-0.3, 0, -0.7);
      eyeL.add(pupilL);
      const pupilR = new THREE.Mesh(pupilGeo, blackMat);
      pupilR.position.set(0.3, 0, -0.7);
      eyeR.add(pupilR);

      // ê·€
      const earGeo = new THREE.ConeGeometry(1.5, 5, 4);
      horse.earL = new THREE.Mesh(earGeo, bodyMat);
      horse.earL.position.set(-2, 5, 0);
      horse.earL.rotation.z = -0.3;
      horse.earL.rotation.x = -0.2;
      horse.head.add(horse.earL);

      horse.earR = new THREE.Mesh(earGeo, bodyMat);
      horse.earR.position.set(2, 5, 0);
      horse.earR.rotation.z = 0.3;
      horse.earR.rotation.x = -0.2;
      horse.head.add(horse.earR);

      // ê°ˆê¸°
      const maneGeo = new THREE.BoxGeometry(1, 4, 2);
      for (let i = 0; i < 5; i++) {
        const mane = new THREE.Mesh(maneGeo, blackMat);
        mane.position.set(0, 8 + i * 0.5, -2 - i * 2);
        mane.rotation.x = -0.5 - i * 0.1;
        horse.headGroup.add(mane);
      }

      horse.mesh.add(horse.headGroup);

      // ê¼¬ë¦¬
      const tailGeo = new THREE.CylinderGeometry(0.5, 1.5, 12, 6);
      horse.tail = new THREE.Mesh(tailGeo, blackMat);
      horse.tail.position.set(0, 16, 14);
      horse.tail.rotation.x = 0.8;
      horse.tail.castShadow = true;
      horse.mesh.add(horse.tail);

      // ë‹¤ë¦¬
      const legPositions = [
        { x: -4, z: 7 },   // ë’·ë‹¤ë¦¬ ì™¼ìª½
        { x: 4, z: 7 },    // ë’·ë‹¤ë¦¬ ì˜¤ë¥¸ìª½
        { x: -4, z: -7 },  // ì•ë‹¤ë¦¬ ì™¼ìª½
        { x: 4, z: -7 },   // ì•ë‹¤ë¦¬ ì˜¤ë¥¸ìª½
      ];

      legPositions.forEach((pos) => {
        const legGroup = new THREE.Group();
        legGroup.position.set(pos.x, 10, pos.z);

        const thighGeo = new THREE.CylinderGeometry(2, 1.5, 8, 6);
        const thigh = new THREE.Mesh(thighGeo, bodyMat);
        thigh.position.y = -2;
        thigh.castShadow = true;
        legGroup.add(thigh);

        const calfGeo = new THREE.CylinderGeometry(1.5, 1, 7, 6);
        const calf = new THREE.Mesh(calfGeo, bodyMat);
        calf.position.y = -9;
        calf.castShadow = true;
        legGroup.add(calf);

        const hoofGeo = new THREE.CylinderGeometry(1.2, 1.5, 2, 6);
        const hoof = new THREE.Mesh(hoofGeo, hoofMat);
        hoof.position.y = -13.5;
        hoof.castShadow = true;
        legGroup.add(hoof);

        horse.mesh.add(legGroup);
        horse.legs.push(legGroup);
      });

      scene.add(horse.mesh);
    }

    function setupEventListeners() {
      // Motion buttons
      document.querySelectorAll('.btn[data-motion]').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.btn[data-motion]').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentMotion = btn.dataset.motion;
          document.getElementById('current-motion').textContent = currentMotion.toUpperCase();
          document.getElementById('motion-desc').textContent = motionDescriptions[currentMotion];

          // ëª¨ì…˜ ì´ˆê¸°í™”
          if (horse) {
            resetMotion(horse);
          }
        });
      });

      // Camera buttons
      document.querySelectorAll('.cam-btn[data-view]').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.cam-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          setCameraView(parseInt(btn.dataset.view));
        });
      });

      window.addEventListener('resize', onWindowResize);
    }

    function setCameraView(view) {
      switch (view) {
        case 0: // ì •ë©´
          camera.position.set(0, 30, 80);
          break;
        case 1: // ì¸¡ë©´
          camera.position.set(80, 30, 0);
          break;
        case 2: // ìœ„
          camera.position.set(0, 100, 10);
          break;
        case 3: // ë’¤
          camera.position.set(0, 30, -80);
          break;
        case 4: // 45ë„
          camera.position.set(50, 40, 50);
          break;
      }
      controls.target.set(0, 15, 0);
      controls.update();
    }

    function getSkillTypeFromMotion(motion) {
      const map = {
        idle: SkillType.IDLE,
        run: SkillType.RUN,
        boost: SkillType.BOOST,
        stun: SkillType.STUN,
        back: SkillType.BACK,
        shock: SkillType.SHOCK,
        walk: SkillType.WALK,
        fallen: SkillType.FALLEN,
      };
      return map[motion] || SkillType.RUN;
    }

    function animate() {
      requestAnimationFrame(animate);
      controls.update();

      if (horse) {
        // ì‹¤ì œ motion.jsì˜ updateMotion í•¨ìˆ˜ ì‚¬ìš©
        const status = getSkillTypeFromMotion(currentMotion);

        // ì‹¤ì œ ê²Œì„ê³¼ ë™ì¼í•œ wobbleOffset (ê° ë§ë§ˆë‹¤ ëœë¤ê°’ * 100)
        // updateMotion ë‚´ë¶€ì—ì„œ Date.now() * 0.015 + wobbleOffset ê³„ì‚°ë¨
        updateMotion(horse, status, horse.wobbleOffset);
      }

      renderer.render(scene, camera);
    }

    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    init();
  </script>
</body>
</html>
